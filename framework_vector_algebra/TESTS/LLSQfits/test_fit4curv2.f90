program test_fit4curv

use fholder_systslv
use fholder_genfuns
use frmwork_space3d
use dholder_impdefs
use frmwork_basefuns
use frmwork_llsqfit
use fholder_pgrids
use frmwork_parafuns

implicit none

type(point), dimension(:), allocatable :: psample, gridp
type(point),target :: mid,origin
type(gen_fit) :: myfit
real(kind(0.d0)), dimension(6) :: hess
type(vector) :: gradfit, unit_u, unit_v, unit_w
real(kind(0.d0)) :: curvature, area_sumparts,csum, t1,t2, ax, ay, bx, by, sfx, sfy, az, bz, a, b
real(kind(0.d0)), dimension(:), allocatable :: f
integer,dimension(:), allocatable :: loc
logical,dimension(:), allocatable :: rem
real(kind(0.d0)), dimension(:), allocatable :: AA
integer :: i, n
logical :: is_sing
integer, dimension(:), allocatable :: is, i0, j0, k0

!allocate(psample(23))
!n=3
! psample(1)=point( -0.125000000000000    ,   0.350000000000000    ,   0.333743981218898 )
! psample(2)=point( -0.144894614362053    ,   0.350000000000000    ,   0.325000000000000 )
! psample(3)=point( -0.125000000000000    ,   0.358287556124091    ,   0.325000000000000 )
! psample(4)=point( -0.175000000000000    ,   0.336249217725485    ,   0.325000000000000 )
! psample(5)=point( -0.175000000000000    ,   0.350000000000000    ,   0.310153910846979 )
! psample(6)=point( -0.150000000000000    ,   0.350000000000000    ,   0.322503383728945 )
! psample(7)=point( -0.150000000000000    ,   0.347640548123735    ,   0.325000000000000 )
! psample(8)=point( -0.175000000000000    ,   0.325000000000000    ,   0.336249217725485 )
! psample(9)=point( -0.150000000000000    ,   0.325000000000000    ,   0.347640548123735 )
! psample(10)=point(-0.125000000000000   ,    0.333743981218898   ,    0.350000000000000)
! psample(11)=point(-0.144894614362053   ,    0.325000000000000   ,    0.350000000000000)
! psample(12)=point(-0.175000000000000   ,    0.359033857671887   ,    0.300000000000000)
! psample(13)=point(-0.150000000000000   ,    0.369249205412283   ,    0.300000000000000)
! psample(14)=point(-0.136000800076833   ,    0.375000000000000   ,    0.300000000000000)
! psample(15)=point(-0.125000000000000   ,    0.375000000000000   ,    0.305303867239189)
! psample(16)=point(-0.100000000000000   ,    0.350000000000000   ,    0.341207004954154)
! psample(17)=point(-0.100000000000000   ,    0.341207004954154   ,    0.350000000000000)
! psample(18)=point(-0.100000000000000   ,    0.375000000000000   ,    0.313825453914556)
! psample(19)=point(-0.100000000000000   ,    0.365218018897942   ,    0.325000000000000)
! psample(20)=point(-0.125000000000000   ,    0.379538430331974   ,    0.300000000000000)
! psample(21)=point(-0.100000000000000   ,    0.386560935029972   ,    0.300000000000000)
! psample(22)=point(-0.125000000000000   ,    0.325000000000000   ,    0.358287556124091)
! psample(23)=point(-0.100000000000000   ,    0.325000000000000   ,    0.365218018897942)
! 
! allocate(psample(25))
! n=4
! psample(1)=point(   7.499999999999996E-002  , 0.347497093694256     ,   0.350000000000000 )      
! psample(2)=point(   7.499999999999996E-002  , 0.350000000000000     ,   0.347497093694256 )      
! psample(3)=point(   0.100000000000000       , 0.350000000000000     ,   0.341207004954154 )      
! psample(4)=point(   0.100000000000000       , 0.341207004954154     ,   0.350000000000000 )      
! psample(5)=point(   6.349087322287582E-002  , 0.350000000000000     ,   0.350000000000000 )      
! psample(6)=point(   0.125000000000000       , 0.350000000000000     ,   0.333743981218898 )      
! psample(7)=point(   0.125000000000000       , 0.333743981218898     ,   0.350000000000000 )      
! psample(8)=point(   7.499999999999996E-002  , 0.375000000000000     ,   0.320353038707691 )      
! psample(9)=point(   7.499999999999996E-002  , 0.370839324541934     ,   0.325000000000000 )    
! psample(10)=point(  5.348883127085362E-002 ,  0.375000000000000    ,    0.325000000000000 )    
! psample(11)=point(  5.000000000000004E-002 ,  0.352889478333473    ,    0.350000000000000 )    
! psample(12)=point(  5.000000000000004E-002 ,  0.375000000000000    ,    0.325785727894324 )    
! psample(13)=point(  0.100000000000000      ,  0.375000000000000    ,    0.313825453914556 )    
! psample(14)=point(  0.100000000000000      ,  0.365218018897942    ,    0.325000000000000 )    
! psample(15)=point(  0.125000000000000      ,  0.375000000000000    ,    0.305303867239189 )    
! psample(16)=point(  0.125000000000000      ,  0.358287556124092    ,    0.325000000000000 )    
! psample(17)=point(  7.499999999999996E-002 ,  0.325000000000000    ,    0.370839324541934 )    
! psample(18)=point(  7.499999999999996E-002 ,  0.320353038707692    ,    0.375000000000000 )    
! psample(19)=point(  5.348883127085364E-002 ,  0.325000000000000    ,    0.375000000000000 )    
! psample(20)=point(  0.100000000000000      ,  0.325000000000000    ,    0.365218018897942 )    
! psample(21)=point(  0.100000000000000      ,  0.313825453914556    ,    0.375000000000000 )    
! psample(22)=point(  5.000000000000004E-002 ,  0.325785727894324    ,    0.375000000000000 )    
! psample(23)=point(  5.000000000000004E-002 ,  0.350000000000000    ,    0.352889478333473 )    
! psample(24)=point(  0.125000000000000      , 0.325000000000000     ,    0.358287556124091 )   
! psample(25)=point(  0.125000000000000      , 0.305303867239189     ,    0.375000000000000 )
! 
! allocate(psample(30))
! n=3
! psample(1)=point(     0.300000000000000  ,    -0.300000000000000    ,   0.239236529381464     )
! psample(2)=point(     0.239236529381464  ,    -0.300000000000000    ,   0.300000000000000     )
! psample(3)=point(     0.300000000000000  ,    -0.239236529381464    ,   0.300000000000000     )
! psample(4)=point(     0.200000000000000  ,    -0.400000000000000    ,   0.195286359648904     )
! psample(5)=point(     0.195286359648903  ,    -0.400000000000000    ,   0.200000000000000     )
! psample(6)=point(     0.200000000000000  ,    -0.397945075585563    ,   0.200000000000000     )
! psample(7)=point(     0.100000000000000  ,    -0.400000000000000    ,   0.256032628132990     )
! psample(8)=point(     0.100000000000000  ,    -0.369490655730898    ,   0.300000000000000     )
! psample(9)=point(     0.200000000000000  ,    -0.330446525157898    ,   0.300000000000000     )
! psample(10)=point(    0.300000000000000  ,    -0.330446525157898    ,   0.200000000000000     )
! psample(11)=point(    0.300000000000000  ,    -0.369490655730898    ,   9.999999999999987E-002)
! psample(12)=point(    0.256032628132991  ,    -0.400000000000000    ,   9.999999999999987E-002)
! psample(13)=point(    0.330446525157898  ,    -0.300000000000000    ,   0.200000000000000     )
! psample(14)=point(    0.369490655730898  ,    -0.300000000000000    ,   9.999999999999987E-002)
! psample(15)=point(    0.397945075585563  ,    -0.200000000000000    ,   0.200000000000000     )
! psample(16)=point(    0.400000000000000  ,    -0.200000000000000    ,   0.195286359648904     )
! psample(17)=point(    0.400000000000000  ,    -0.256032628132991    ,   9.999999999999987E-002)
! psample(18)=point(    0.330446525157898  ,    -0.200000000000000    ,   0.300000000000000     )
! psample(19)=point(    0.400000000000000  ,    -0.195286359648904    ,   0.200000000000000     )
! psample(20)=point(    0.369490655730898  ,    -0.100000000000000    ,   0.300000000000000     )
! psample(21)=point(    0.400000000000000  ,    -0.100000000000000    ,   0.256032628132991     )
! psample(22)=point(    0.100000000000000  ,    -0.300000000000000    ,   0.369490655730898     )
! psample(23)=point(    0.200000000000000  ,    -0.300000000000000    ,   0.330446525157898     )
! psample(24)=point(    0.100000000000000  ,    -0.256032628132991    ,   0.400000000000000     )
! psample(25)=point(    0.195286359648904  ,    -0.200000000000000    ,   0.400000000000000     )
! psample(26)=point(    0.200000000000000  ,    -0.200000000000000    ,   0.397945075585563     )
! psample(27)=point(    0.300000000000000  ,    -0.200000000000000    ,   0.330446525157898     )
! psample(28)=point(    0.200000000000000  ,    -0.195286359648904    ,   0.400000000000000     )
! psample(29)=point(    0.256032628132991  ,    -0.100000000000000    ,   0.400000000000000     )
! psample(30)=point(    0.300000000000000  ,    -0.100000000000000    ,   0.369490655730898     )
! 
! allocate(psample(51))
! n=4
! psample(1)=point(   0.000000000000000E+000, -0.350000000000000,      -0.357471446839490  )   
! psample(2)=point(   0.000000000000000E+000, -0.357471446839490,      -0.350000000000000  )   
! psample(3)=point(   2.499999999999991E-002, -0.356579757450839,      -0.350000000000000  )   
! psample(4)=point(   2.499999999999991E-002, -0.350000000000000,      -0.356579757450839  )   
! psample(5)=point(  -2.500000000000002E-002, -0.350000000000000,      -0.356579757450838  )   
! psample(6)=point(  -2.500000000000002E-002, -0.356579757450838,      -0.350000000000000  )   
! psample(7)=point(   5.000000000000004E-002, -0.353553911959773,      -0.350000000000000  )   
! psample(8)=point(   5.000000000000004E-002, -0.350000000000000,      -0.353553911959773  )   
! psample(9)=point(  -2.500000000000002E-002, -0.325000000000000,      -0.379330498128880  )   
! psample(10)=point( -2.500000000000002E-002, -0.329693965146699,      -0.375000000000000  )   
! psample(11)=point(  0.000000000000000E+000, -0.330736137136870,      -0.375000000000000  )   
! psample(12)=point(  0.000000000000000E+000, -0.325000000000000,      -0.380285012592048  )   
! psample(13)=point(  2.499999999999991E-002, -0.329693965146700,      -0.375000000000000  )   
! psample(14)=point(  2.499999999999991E-002, -0.325000000000000,      -0.379330498128881  )   
! psample(15)=point(  5.000000000000004E-002, -0.326297146072421,      -0.375000000000000  )   
! psample(16)=point(  5.000000000000004E-002, -0.325000000000000,      -0.376201766299078  )   
! psample(17)=point( -2.500000000000002E-002, -0.375000000000000,      -0.329693965146699  )   
! psample(18)=point( -2.500000000000002E-002, -0.379330498128880,      -0.325000000000000  )   
! psample(19)=point(  0.000000000000000E+000, -0.380285012592048,      -0.325000000000000  )   
! psample(20)=point(  0.000000000000000E+000, -0.375000000000000,      -0.330736137136870  )   
! psample(21)=point(  2.499999999999991E-002, -0.379330498128881,      -0.325000000000000  )   
! psample(22)=point(  2.499999999999991E-002, -0.375000000000000,      -0.329693965146699  )   
! psample(23)=point(  5.000000000000004E-002, -0.376201766299078,      -0.325000000000000  )   
! psample(24)=point(  5.000000000000004E-002, -0.375000000000000,      -0.326297146072421  )   
! psample(25)=point( -5.000000000000004E-002, -0.350000000000000,      -0.353553911959772  )   
! psample(26)=point( -5.000000000000004E-002, -0.353553911959772,      -0.350000000000000  )   
! psample(27)=point( -5.000000000000004E-002, -0.325000000000000,      -0.376201766299078  )   
! psample(28)=point( -5.000000000000004E-002, -0.326297146072420,      -0.375000000000000  )   
! psample(29)=point( -5.000000000000004E-002, -0.375000000000000,      -0.326297146072420  )   
! psample(30)=point( -5.000000000000004E-002, -0.376201766299078,      -0.325000000000000  )   
! psample(31)=point(  6.504012057983301E-002, -0.350000000000000,      -0.350000000000000  )   
! psample(32)=point(  5.527435883353073E-002, -0.325000000000000,      -0.375000000000000  )   
! psample(33)=point(  7.499999999999996E-002, -0.347649954809104,      -0.350000000000000  )   
! psample(34)=point(  7.499999999999996E-002, -0.325000000000000,      -0.370946667974933  )   
! psample(35)=point(  5.527435883353054E-002, -0.375000000000000,      -0.325000000000000  )   
! psample(36)=point(  7.499999999999996E-002, -0.370946667974933,      -0.325000000000000  )   
! psample(37)=point(  7.499999999999996E-002, -0.350000000000000,      -0.347649954809104  )   
! psample(38)=point( -5.000000000000004E-002, -0.300000000000000,      -0.395563985825785  )   
! psample(39)=point( -2.500000000000002E-002, -0.300000000000000,      -0.398199225091398  )   
! psample(40)=point( 0.000000000000000E+000 , -0.300000000000000,      -0.399152533139609  )   
! psample(41)=point( 2.499999999999991E-002 , -0.300000000000000,      -0.398199225091398  )   
! psample(42)=point( 5.000000000000004E-002 , -0.300000000000000,      -0.395563985825785  )   
! psample(43)=point( 7.499999999999996E-002 , -0.320534998600309,      -0.375000000000000  )   
! psample(44)=point( 7.499999999999996E-002 , -0.300000000000000,      -0.391800551422683  )   
! psample(45)=point(-5.000000000000004E-002 , -0.395563985825785,      -0.300000000000000  )   
! psample(46)=point(-2.500000000000002E-002 , -0.398199225091398,      -0.300000000000000  )   
! psample(47)=point( 0.000000000000000E+000 , -0.399152533139610,      -0.300000000000000  )   
! psample(48)=point( 2.499999999999991E-002 , -0.398199225091398,      -0.300000000000000  )   
! psample(49)=point( 5.000000000000004E-002 , -0.395563985825785,      -0.300000000000000  )   
! psample(50)=point( 7.499999999999996E-002 , -0.391800551422683,      -0.300000000000000  )   
! psample(51)=point( 7.499999999999996E-002 , -0.375000000000000,      -0.320534998600309  )

!  allocate(psample(16))
!  n=16
!  psample(1)=point(       -2.857147517751121e-02  ,   2.937695970148146e-02   , -4.692679494580285e-05 )
!  psample(2)=point(       -2.857138196526982e-02  ,  -2.937705039204760e-02   ,  4.690526024932976e-05 )
!  psample(3)=point(        2.857147517751121e-02  ,  -2.937695970148146e-02   ,  4.692679494591821e-05 )
!  psample(4)=point(        2.857138196526982e-02  ,   2.937705039204761e-02   , -4.690526024921440e-05 )
!  psample(5)=point(       -8.571423910805095e-02  ,  -2.781015833205614e-02   , -6.552259760308671e-03 )
!  psample(6)=point(       -8.571414589580957e-02  ,  -8.497410976420779e-02   , -1.315475237979961e-02 )
!  psample(7)=point(       -2.857128875302843e-02  ,  -8.651891281639248e-02   , -6.648612334740071e-03 )
!  psample(8)=point(       -8.571433232029235e-02  ,   3.097152208104995e-02   , -6.762621757600105e-03 )
!  psample(9)=point(        2.857156838975260e-02  ,  -8.651882212582637e-02   , -6.648590800043375e-03 )
!  psample(10)=point(       8.571442553253374e-02  ,  -8.497383769250935e-02   , -1.315468777570985e-02 )
!  psample(11)=point(       8.571433232029235e-02  ,  -2.780988626035774e-02   , -6.552195156218799e-03 )
!  psample(12)=point(       8.571423910805095e-02  ,   3.097179415274837e-02   , -6.762557153510340e-03 )
!  psample(13)=point(      -2.857156838975260e-02  ,   8.972753725076728e-02   , -6.864494463469289e-03 )
!  psample(14)=point(       2.857128875302843e-02  ,   8.972762794133340e-02   , -6.864472928772646e-03 )
!  psample(15)=point(       8.571414589580957e-02  ,   9.142173337339231e-02   , -1.399857354206850e-02 )
!  psample(16)=point(      -8.571442553253374e-02  ,   9.142146130169392e-02   , -1.399863814615842e-02 )

! allocate(psample(18))
! n=18
! 
! psample(1)=point( -1.084202172485504E-019 , 2.502400929126725E-002 ,-6.841315708383533E-017  )
! psample(2)=point(  -2.189737369562018E-003,  2.492801819763803E-002, -6.862999751833243E-017 )
! psample(3)=point(   1.565587937069068E-016, -2.502400929126724E-002, -8.857931749206571E-017 )
! psample(4)=point(   2.189737369562174E-003, -2.492801819763802E-002, -8.836247705756861E-017 )
! psample(5)=point(  -8.041254985630205E-003,  7.471952493397366E-002, -5.857137247700059E-003 )
! psample(6)=point(  -6.539474125608095E-002,  7.220533124706131E-002, -9.636814269476001E-003 )
! psample(7)=point(  -6.777884738855337E-002,  2.205280106502395E-002, -5.058578177807384E-003 )
! psample(8)=point(  -1.493820356669871E-003,  3.407685166134026E-002, -1.095920165627165E-003 )
! psample(9)=point(  -6.558911001899125E-002, -2.789922642388132E-002, -5.058578177807367E-003 )
! psample(10)=point(  5.882552914739451E-002,  7.765075121965449E-002, -9.636814269475904E-003 )
! psample(11)=point(  1.472042876943841E-003,  7.513655753274216E-002, -5.857137247700058E-003 )
! psample(12)=point(  6.558911001899125E-002,  2.789922642388133E-002, -5.058578177807325E-003 )
! psample(13)=point(  6.777884738855337E-002, -2.205280106502394E-002, -5.058578177807378E-003 )
! psample(14)=point( -5.882552914739451E-002, -7.765075121965449E-002, -9.636814269475987E-003 )
! psample(15)=point( -1.472042876943643E-003, -7.513655753274215E-002, -5.857137247700080E-003 )
! psample(16)=point(  1.493820356670033E-003, -3.407685166134033E-002, -1.095920165627192E-003 )
! psample(17)=point(  8.041254985630325E-003, -7.471952493397364E-002, -5.857137247700078E-003 )
! psample(18)=point(  6.539474125608100E-002, -7.220533124706131E-002, -9.636814269476001E-003 )
!psample(19)=point(  1d2 , 203d1, 140d1 )

! allocate(psample(22))
!  n=22
! psample(1)=point(  5.536493430906696E-002  ,1.577004817011753E-002 , 4.890384442645182E-005   )
! psample(2)=point(  -4.886610320909343E-002 , 2.915585731417664E-002,  2.014345061718279E-004  )
! psample(3)=point(  -6.048653369976060E-002 , 3.239911314757666E-003,  4.590727564237861E-004  )
! psample(4)=point(   2.977096046791519E-002 ,-4.100185282252881E-002, -5.632015447412531E-004  )
! psample(5)=point(  -1.707085467012748E-002 , 0.100009608064765     , -2.882826980747629E-004  )
! psample(6)=point(  -0.106302184909811      , 0.152502309687640     , -2.212923814598367E-002  )
! psample(7)=point(  -0.149684615769549      , 5.599994699978911E-002, -2.212266155370877E-002  )
! psample(8)=point(  -8.435295715813521E-002 , 1.737906732185618E-002, -5.641348377702700E-003  )
! psample(9)=point(   7.313557075264301E-002 , 5.535722237843922E-002, -1.727305604846798E-004  )
! psample(10)=point( -0.155570384057574      ,-5.423167556494075E-002, -3.468083775303945E-002  )
! psample(11)=point( -0.102842800631507      ,-8.501151388750526E-002, -2.239758040037511E-002  )
! psample(12)=point( -1.257894793493407E-002 ,-0.129202151861616     , -2.356152456837936E-002  )
! psample(13)=point(  0.164307720627814      , 1.846980666201223E-002, -2.157379913739764E-002  )
! psample(14)=point(  0.132512472088848      ,-5.238394408857673E-002, -2.108408193315097E-002  )
! psample(15)=point(  0.120892041598181      ,-7.829989008799559E-002, -2.082644368289909E-002  )
! psample(16)=point(  7.853577466643444E-002 ,-0.166551315290259     , -4.368309683969789E-002  )
! psample(17)=point(  1.978987882065894E-003 , 0.221633381450035     , -3.446201001015067E-002  )
! psample(18)=point( -8.040060288933383E-002 , 0.214933967349931     , -4.057713079216025E-002  )
! psample(19)=point(  2.742801441550288E-002 , 0.205488764573826     , -2.516942656260097E-002  )
! psample(20)=point(  0.117514869854112      , 0.159874968690202     , -2.238982052055041E-002  )
! psample(21)=point( -0.192091951446201      ,-3.266209975151360E-002, -4.384148827175260E-002  )
! psample(22)=point(  0.208806589713444      , 0.123948963171073     , -4.645494300192384E-002  )

! n=20
! allocate(psample(n))
! psample(1)=point(  -2.170448052620618E-002 ,-1.591882320521912E-003 , 5.544577694480144E-004)
! psample(2)=point(   6.824334448224914E-003 ,-1.694651000703021E-002 ,-6.059866252982275E-004)
! psample(3)=point(   1.488014607798124E-002 , 1.853839232755206E-002 , 5.152885585002747E-005)
! psample(4)=point(  -2.898301383766876E-002 ,-0.110267290896552      ,-2.556668851266856E-002)
! psample(5)=point(   6.529205469408973E-002 ,-0.147612112303632      ,-5.382720032059224E-002)
! psample(6)=point(   0.101368386205243      ,-5.476544922643121E-002 ,-2.827689407095803E-002)
! psample(7)=point(   0.125560767459029      , 5.488260534586348E-002 ,-2.121661729208865E-002)
! psample(8)=point(   3.172657799057101E-002 , 9.559593200705449E-002 , 4.510040863033929E-004)
! psample(9)=point(   0.128707552751540      , 5.348160000875365E-002 ,-2.187823035264117E-002)
! psample(10)=point( -0.134119668369172      ,-5.377751579373376E-002 ,-2.111449590519025E-002)
! psample(11)=point( -9.958089874025289E-002 ,-7.300985484234956E-002 ,-2.134680954807621E-002)
! psample(12)=point( -9.916399290014705E-002 , 4.104444886795975E-002 , 1.979360911964489E-003)
! psample(13)=point( -5.573044795965607E-002 , 0.145756068113253      ,-1.625062606829153E-003)
! psample(14)=point( -8.176116951266213E-002 , 0.131405551948443      ,-1.289257578727415E-003)
! psample(15)=point( -0.224310246808464      , 5.682520408007284E-003 ,-3.735448956203945E-002)
! psample(16)=point( -0.157454945857730      , 7.947398588911173E-002 ,-8.516687818003923E-003)
! psample(17)=point(  0.129029536523353      , 5.571403698018242E-002 ,-2.213052529130548E-002)
! psample(18)=point(  0.143761801730802      , 0.183382409383786      ,-4.240779229068413E-002)
! psample(19)=point(  0.114976381177655      , 0.197182208457904      ,-3.814993538128046E-002)
! psample(20)=point(  4.068132545346975E-002 , 0.183376518419511      ,-1.535736291899716E-002)

! n=16
! allocate(psample(n))
! psample(1)=point(   1.242498867458502E-002,  1.305561745265157E-002,  1.222746138931495E-004)
! psample(2)=point(  -1.258106862959136E-002,  1.274767396698029E-002,  1.075020992387016E-004)
! psample(3)=point(  -1.242462168878871E-002, -1.305720142982938E-002, -1.160856115096865E-004)
! psample(4)=point(   1.258172559017813E-002, -1.274597193960844E-002, -1.136898116294182E-004)
! psample(5)=point(  -3.762601956642861E-002,  2.747208477231664E-002, -1.868306349307187E-003)
! psample(6)=point(  -3.755856343648210E-002,  1.276340170763062E-002, -1.126375985190994E-003)
! psample(7)=point(  -1.265930281874313E-002,  2.962753005309162E-002, -7.110912306051905E-004)
! psample(8)=point(   1.235753254463851E-002,  2.776430051733784E-002, -6.196557502231488E-004)
! psample(9)=point(  -3.740182652088899E-002, -1.303818768462941E-002, -1.362340410713454E-003)
! psample(10)=point(  3.746055046767638E-002,  1.369790684699764E-002, -1.122264562915409E-003)
! psample(11)=point(  3.742479553531543E-002,  2.185761860260984E-002, -1.600571084667539E-003)
! psample(12)=point(  3.761730299888526E-002, -1.210350558855385E-002, -1.358895494730240E-003)
! psample(13)=point( -3.721651291310196E-002, -3.851594499336802E-002, -2.818016273608474E-003)
! psample(14)=point( -1.223915534500782E-002, -3.853322792890025E-002, -1.578280557766374E-003)
! psample(15)=point(  1.276703919796517E-002, -3.822372924834706E-002, -1.569365674524438E-003)
! psample(16)=point(  3.780218398242725E-002, -3.758616541049113E-002, -2.796106073533386E-003)
! psample(17)=point( -1.270046237171563E-002,  3.897243751766463E-002, -1.250416191916885E-003)
! psample(18)=point( -3.767734093662854E-002,  3.899514853413567E-002, -2.510596739327443E-003)
! psample(19)=point(  1.230621117443858E-002,  3.928736427915668E-002, -1.261946140243515E-003)
! psample(20)=point(  3.734254406126711E-002,  3.993839173492020E-002, -2.539397168575361E-003)
! psample(1)=point(  -1.249994054052347E-002 , 1.250397239272526E-002 ,  7.893922920965482E-007)
! psample(2)=point(  -1.250005945919360E-002 ,-1.250385351145725E-002 ,-7.864099735569092E-007 )
! psample(3)=point(   1.249994054052347E-002 ,-1.250397239272526E-002 ,-7.893922922630275E-007 )
! psample(4)=point(   1.250005945919360E-002 , 1.250385351145725E-002 , 7.864099733904300E-007 )
! psample(5)=point(  -3.749982162157058E-002 , 3.757496941080437E-002 ,-2.511022049614719E-003 )
! psample(6)=point(  -3.749994054024069E-002 , 1.253552813607504E-002 ,-1.252344883403735E-003 )
! psample(7)=point(  -1.249982162185337E-002 , 3.754329443708081E-002 ,-1.253135008732664E-003 )
! psample(8)=point(  -3.750005945891082E-002 ,-1.247233721223985E-002 ,-1.252348362332398E-003 )
! psample(9)=point(   1.250017837786371E-002 , 3.754317555581280E-002 ,-1.253137991051370E-003 )
! psample(10)=point( -3.750017837758098E-002 ,-3.744874593926523E-002 ,-2.506276741477363E-003 )
! psample(11)=point( -1.250017837786376E-002 ,-3.748030168261501E-002 ,-1.253142465781531E-003 )
! psample(12)=point(  1.249982162185332E-002 ,-3.748042056388302E-002 ,-1.253145448100237E-003 )
! psample(13)=point(  3.750005945891088E-002 , 1.253517149227101E-002 ,-1.252353830359853E-003 )
! psample(14)=point(  3.750017837758098E-002 , 3.757461276700034E-002 ,-2.511030996570838E-003 )
! psample(15)=point(  3.749994054024074E-002 ,-1.247269385604388E-002 ,-1.252357309288516E-003 )
! psample(16)=point(  3.749982162157059E-002 ,-3.744910258306926E-002 ,-2.506285688433481E-003 )



! n=16
! allocate(psample(n))
! psample(1)=point(    1.250005945919378E-002 ,-1.250385351145702E-002 ,-7.864099736097641E-007)
! psample(2)=point(    1.249994054052330E-002 , 1.250397239272538E-002 , 7.893922920381097E-007)
! psample(3)=point(   -1.250005945919378E-002 , 1.250385351145702E-002 , 7.864099733319915E-007)
! psample(4)=point(   -1.249994054052330E-002 ,-1.250397239272538E-002 ,-7.893922923158823E-007)
! psample(5)=point(    3.750017837758149E-002 ,-3.744874593926477E-002 ,-2.506276741477416E-003)
! psample(6)=point(    3.750005945891099E-002 ,-1.247233721223928E-002 ,-1.252348362332451E-003)
! psample(7)=point(    1.250017837786428E-002 ,-3.748030168261490E-002 ,-1.253142465781584E-003)
! psample(8)=point(    3.749994054024052E-002 , 1.253552813607550E-002 ,-1.252344883403794E-003)
! psample(9)=point(   -1.249982162185280E-002 ,-3.748042056388325E-002 ,-1.253145448100290E-003)
! psample(10)=point(   3.749982162157007E-002 , 3.757496941080493E-002 ,-2.511022049614778E-003)
! psample(11)=point(   1.249982162185285E-002 , 3.754329443708103E-002 ,-1.253135008732723E-003)
! psample(12)=point(  -1.250017837786422E-002 , 3.754317555581267E-002 ,-1.253137991051429E-003)
! psample(13)=point(  -3.749994054024058E-002 ,-1.247269385604434E-002 ,-1.252357309288569E-003)
! psample(14)=point(  -3.749982162157008E-002 ,-3.744910258306983E-002 ,-2.506285688433534E-003)
! psample(15)=point(  -3.750005945891104E-002 , 1.253517149227044E-002 ,-1.252353830359912E-003)
! psample(16)=point(  -3.750017837758150E-002 , 3.757461276699987E-002 ,-2.511030996570897E-003)

!   n=24
!   allocate(psample(n))
!  psample(1)=point(    0.000000000000000E+000 , 1.340629677887478E-002 ,-7.719519468096792E-017 )
!  psample(2)=point(   -9.035851104074032E-003 , 9.903645194991212E-003 ,-7.719519468096792E-017 )
!  psample(3)=point(   -1.734723475976807E-018 ,-1.340629677887478E-002 ,-7.979727989493313E-017 )
!  psample(4)=point(    9.035851104074030E-003 ,-9.903645194991208E-003 ,-7.979727989493313E-017 )
!  psample(5)=point(   -1.691413268568927E-002 , 3.366230668344378E-002 ,-1.241497644821153E-003 )
!  psample(6)=point(   -4.415475542869204E-002 , 2.310276898214926E-002 ,-2.309817254651965E-003 )
!  psample(7)=point(   -3.386845646874696E-002 , 2.775498210523582E-004 ,-9.687072496668107E-004 )
!  psample(8)=point(   -2.483260536467293E-002 ,-2.303239215281364E-002 ,-9.687072496668107E-004 )
!  psample(9)=point(    1.704720211646987E-002 , 4.682705693944893E-002 ,-2.309817254651965E-003 )
!  psample(10)=point(  -1.019342062653290E-002 , 3.626751923815440E-002 ,-1.241497644821153E-003 )
!  psample(11)=point(   2.483260536467293E-002 , 2.303239215281364E-002 ,-9.687072496668090E-004 )
!  psample(12)=point(   3.386845646874696E-002 ,-2.775498210523548E-004 ,-9.687072496668125E-004 )
!  psample(13)=point(  -1.704720211646983E-002 ,-4.682705693944903E-002 ,-2.309817254651972E-003 )
!  psample(14)=point(   1.019342062653294E-002 ,-3.626751923815451E-002 ,-1.241497644821162E-003 )
!  psample(15)=point(   1.691413268568931E-002 ,-3.366230668344389E-002 ,-1.241497644821162E-003 )
!  psample(16)=point(   4.415475542869208E-002 ,-2.310276898214936E-002 ,-2.309817254651972E-003 )
!  psample(17)=point(  2.146327278194137E-002  , 4.853889976784408E-002 ,-2.644914554400180E-003 )
!  psample(18)=point(  3.158654926101277E-002  , 2.565048667578661E-002 ,-1.478646770232715E-003 )
!  psample(19)=point(  4.062240036508680E-002  , 2.340544701920618E-003 ,-1.478646770232715E-003 )
!  psample(20)=point( -4.857082609416355E-002  , 2.139092615375411E-002 ,-2.644914554400180E-003 )
!  psample(21)=point( -4.062240036508680E-002  ,-2.340544701920614E-003 ,-1.478646770232715E-003 )
!  psample(22)=point( -3.158654926101277E-002  ,-2.565048667578661E-002 ,-1.478646770232715E-003 )
!  psample(23)=point( -2.146327278194134E-002  ,-4.853889976784419E-002 ,-2.644914554400187E-003)
!  psample(24)=point(  4.857082609416358E-002  ,-2.139092615375421E-002 ,-2.644914554400187E-003)

! n=21
!  allocate(psample(n))
! psample(1)=point(   7.528704083710086E-003 , 6.863369083414255E-003 , 8.290451311030204E-006)
! psample(2)=point(  -5.008353946068209E-003 ,-2.097932090766107E-003 ,-3.431269503889178E-005)
! psample(3)=point(  -2.520350137641900E-003 ,-4.765436992648125E-003 , 2.602224372774079E-005)
! psample(4)=point(   1.402617734895049E-002 , 1.441270760486354E-002 ,-2.613851419327150E-005)
! psample(5)=point(  -9.092207781725186E-003 , 3.922660056716498E-002 ,-7.435607621198402E-004)
! psample(6)=point(  -2.559805473116018E-002 , 1.999116899663218E-002 ,-6.127306132769888E-004)
! psample(7)=point(   1.567782762988095E-002 , 1.264371833731793E-002 , 3.561655845066530E-006)
! psample(8)=point(   3.609183362921453E-002 ,-8.918716012975596E-003 ,-1.344518722544642E-003)
! psample(9)=point(   1.922145042172652E-002 ,-2.764080188456863E-002 ,-1.918641049599629E-003)
! psample(10)=point( -4.299425363270657E-002 , 2.009545065427637E-003 ,-2.203693013723227E-003)
! psample(11)=point( -2.431861311386946E-002 ,-1.803099622215137E-002 ,-1.651273217465596E-003)
! psample(12)=point( -1.991106921818998E-002 ,-2.275477769407319E-002 ,-1.554343094574749E-003)
! psample(13)=point(  1.782551621906346E-003 ,-4.556229514662908E-002 ,-3.592177949409699E-003)
! psample(14)=point( -8.003552514570092E-003 , 4.065464896209284E-002 ,-8.724272252265651E-004)
! psample(15)=point( -9.524483740284381E-003 , 3.969541586766085E-002 ,-7.844547780179074E-004)
! psample(16)=point( -3.002812512375170E-002 , 2.479570355655331E-002 ,-1.031822550908720E-003)
! psample(17)=point(  3.011231014333103E-002 , 3.423918725777922E-002 ,-9.686260118969402E-004)
! psample(18)=point(  1.204229272506379E-002 , 5.367455758735088E-002 ,-1.757200796674348E-003)
! psample(19)=point(  3.720281213134913E-002 , 2.665904779416497E-002 ,-9.212215475728722E-004)
! psample(20)=point(  5.252665523523662E-002 , 1.041673456458658E-002 ,-1.612700069201924E-003)
!psample(21)=point( -4.921355103040183E-002 , 8.754546078419342E-003 ,-2.792048765692067E-003)

 n=72
  allocate(psample(n))
psample(1)=point(   -2.082224756767272E-002 , -1.355718717739112E-002  , 1.550499550817558E-003  )
psample(2)=point(    2.138237175673931E-002 , -1.459901483783511E-002  , 9.960074446780584E-004  )
psample(3)=point(   -5.601241890665831E-004 ,  2.815620201522623E-002  ,-2.546506995495618E-003  )
psample(4)=point(    6.246535669318438E-002 ,  4.340616698905265E-002  ,-2.396570869709534E-003  )
psample(5)=point(    9.850456211758021E-003 ,  4.496776864192329E-002  ,-1.329440477875920E-003  )
psample(6)=point(    4.692572656858758E-002 , -1.526275724738489E-002  , 6.129283175545092E-004  )
psample(7)=point(    7.019175901267774E-002 ,  3.198151581443126E-002  ,-3.621813121712360E-003  )
psample(8)=point(   -1.201757876128967E-002 ,  4.552340985019646E-002  ,-1.019499757629442E-003  )
psample(9)=point(   -5.764086884272489E-002 ,  4.682329637564778E-002  ,-1.717004892380983E-004  )
psample(10)=point(  -7.131627288729785E-002 ,  2.405568286551671E-002  ,-1.278785341960131E-003  )
psample(11)=point(  -5.280830076123312E-002 , -1.264619972235002E-002  , 2.144382102470099E-003  )
psample(12)=point(   3.474638434046745E-002 ,  8.812906847376192E-002  ,-5.456861720242222E-004  )
psample(13)=point(   9.534537475028834E-002 , -1.642374259778951E-002  , 2.578474008375908E-005  )
psample(14)=point(  -3.600505109998326E-002 ,  8.433264376264524E-002  , 5.094215492266255E-004  )
psample(15)=point(   2.330863079224152E-002 ,  0.106767365672195       , 9.261258073609002E-005  )
psample(16)=point(  -2.231465928919361E-002 ,  0.108067252197646       , 9.404118491274996E-004  )
psample(17)=point(  -8.854455414556553E-002 , -1.183661979254314E-002  , 2.510089933107529E-003  )
psample(18)=point(   9.779156624671551E-002 ,  0.104650122811051       ,-1.284458531343943E-003  )
psample(19)=point(   4.517666576528913E-002 ,  0.106211724463921       ,-2.173281395104519E-004  )
psample(20)=point(   7.724359054741910E-002 ,  4.305486898739321E-002  ,-2.571414270128532E-003  )
psample(21)=point(   0.105499617308754       , 9.204146779171915E-002  ,-1.681879944436117E-003  )
psample(22)=point(   0.136722193805815       , 4.141612753280022E-002  ,-3.596719482758325E-003   )
psample(23)=point(   0.114908757237398       ,-1.683098597868450E-002  ,-1.229975256063498E-004   )
psample(24)=point(   0.140935381190308       , 3.527383701973153E-002  ,-4.324466424046172E-003   )
psample(25)=point(   -5.095266503578983E-002 ,  0.108759913611154      ,  1.296250149364152E-003  )
psample(26)=point(   -9.016217283490667E-002 ,  0.109714662319483      ,  1.792592292218301E-003  )
psample(27)=point(   -0.106749965977845      ,  8.095691889696477E-002 ,  1.270388250129810E-003  )
psample(28)=point(   -8.627887458932088E-002 ,  4.751595778915524E-002 ,  1.841378109985053E-004  )
psample(29)=point(   -0.125488382388438      ,  4.847070649748465E-002 ,  6.804799538526057E-004  )
psample(30)=point(   -0.142071131591839      ,  2.003839275298865E-002 , -6.925499556344888E-005  )
psample(31)=point(   -0.126845677006000      , -1.077962941410136E-002 ,  3.172802055922491E-003  )
psample(32)=point(    7.007259389399864E-002 ,  0.149373024295760      ,  5.664261663415006E-004  )
psample(33)=point(   -6.788415464520706E-004 ,  0.145576599584643      ,  1.621533887592216E-003  )
psample(34)=point(   5.863484034577244E-002  , 0.168011321494193       , 1.204724919101960E-003   )
psample(35)=point(   1.301155026433765E-002  , 0.169311208019644       , 2.052524187493236E-003   )
psample(36)=point(   0.168687798672879       ,-1.789933126107242E-002  ,-4.588333413842877E-004   )
psample(37)=point(  -7.142375642431388E-002  , 0.142200874718963       , 2.382500588495415E-003  )
psample(38)=point(  -1.562645548225866E-002  , 0.170003869433152       , 2.408362487729833E-003  )
psample(39)=point(  -5.483596328137560E-002  , 0.170958618141481       , 2.904704630583871E-003  )
psample(40)=point(  -0.156472076197558       ,-1.023595789437861E-002  , 3.293634349430016E-003  )
psample(41)=point(   0.133117775800247        ,0.165894078633049       ,-1.723461929784009E-004  )
psample(42)=point(   8.050287531882054E-002   ,0.167455680285920       , 8.947841988554096E-004  )
psample(43)=point(   0.112569800100950        ,0.104298824809391       ,-1.459301931762934E-003  )
psample(44)=point(   0.140825826862285        ,0.153285423613717       ,-5.697676060705814E-004  )
psample(45)=point(   0.172048403359346        ,0.102660083354799       ,-2.484607144392588E-003  )
psample(46)=point(   0.144832947815108        ,4.125662056112198E-002  ,-3.645056430639594E-003  )
psample(47)=point(   0.176249258123051        ,9.572210510947807E-002  ,-2.656032508714240E-003  )
psample(48)=point(   0.210234379981601        ,3.984503026714352E-002  ,-4.214176937711575E-003  )
psample(49)=point(    0.183407841516604       ,-1.809768940064493E-002 , -4.162220728173710E-004 )
psample(50)=point(    0.211666520244619       , 3.776076022766991E-002 , -4.464009016214895E-003 )
psample(51)=point(   -8.924373897652424E-002  , 0.171634094672267      ,  3.108058848440898E-003 )
psample(52)=point(   -0.123332815462386       , 0.172226625757589      ,  3.199844003587124E-003 )
psample(53)=point(   -0.142156784188142       , 0.139592093957966      ,  2.607242415658684E-003 )
psample(54)=point(   -0.124569948530056       , 0.110390138850269      ,  1.995946510075508E-003 )
psample(55)=point(   -0.158659025015917       , 0.110982669935591      ,  2.087731665221776E-003 )
psample(56)=point(   -0.177482993741673       , 7.834813813596847E-002 ,  1.495130077293155E-003 )
psample(57)=point(   -0.159896158083586       , 4.914618302827056E-002 ,  8.838341717097575E-004 )
psample(58)=point(  -0.193985234569448        ,4.973871411359286E-002  , 9.756193268560809E-004   )
psample(59)=point(  -0.212815809588750        ,1.667795119727620E-002  , 6.810260622687331E-004   )
psample(60)=point(  -0.200285441330876       ,-9.249276834802291E-003  , 3.733589237475493E-003   )
psample(61)=point(   0.105398803447530       , 0.210616980117759        ,1.678538504706654E-003   )
psample(62)=point(   3.464736800707912E-002  , 0.206820555406641        ,2.733646225957821E-003   )
psample(63)=point(   9.396104989930437E-002  , 0.229255277316191        ,2.316837257466918E-003   )
psample(64)=point(   4.833775981786861E-002  , 0.230555163841642        ,3.164636525858557E-003   )
psample(65)=point(  -3.609754687078269E-002  , 0.203444830540961        ,3.494612926860936E-003   )
psample(66)=point(   1.969975407127274E-002  , 0.231247825255150        ,3.520474826095188E-003   )
psample(67)=point(  -1.950975372784452E-002  , 0.232202573963479        ,4.016816968949302E-003   )
psample(68)=point(   0.240950339610393       ,-1.876737547504304E-002  ,-9.844037667221250E-005   )
psample(69)=point(  -0.106830574634610       , 0.200836049779965        ,3.719354754024157E-003   )
psample(70)=point(  -5.391752942299308E-002  , 0.232878050494265        ,4.220171186806468E-003   )
psample(71)=point(  -8.800660590885481E-002  , 0.233470581579587        ,4.311956341952805E-003   )
psample(72)=point(  -0.224945739428140       ,-8.954401190907485E-003   ,3.608666575035627E-003   )
                                                                        
                                                                        
                                                                        
! scale                                                                 
az=minval(psample%z)                                                    
bz=maxval(psample%z)                                                    
                                                                        
!az=0                                                                   
!bz=2

!psample = psample * 2d0 / (bz-az)
!psample%z = psample%z 
!bz = 2
!psample = psample * bz
ax=minval(psample%x)
bx=maxval(psample%x)
ay=minval(psample%y)
by=maxval(psample%y)

psample%x = 2d0*psample%x/(bx - ax)-(bx+ax)/(bx-ax)
psample%y = 2d0*psample%y/(by - ay)-(by+ay)/(by-ay)

sfx = 2d0 / (bx - ax)
sfy = 2d0 / (by - ay)
print *, " "
print *, "Scales =", sfx, sfy
print *, " "
origin = sum(psample)/size(psample)

allocate(rem(25),source=.false.)

rem(1:15) = .true.
!rem(10:11) = .true.
!rem(10:20) = .true.

!allocate(gridp,source=pack(psample,rem))

!call move_alloc(gridp,psample)

print *, size(psample)

!psample%z=psample%x**2+psample%y**2

!allocate(gridp,source=((/mid,psample(4:23)/)))
!allocate(gridp,source=(/psample(4:23)/))

!call move_alloc(gridp,psample)


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 mid = sum(psample(1:n))/n
! 
! !unit_w=unit((psample(2)-mid).x.(psample(1)-mid))
! !unit_w=vector(-0.284766880113168   ,    0.703720610245964    ,   0.650910997530124)
 unit_w = vec0
 do i=1,n-1
   unit_v = (psample(i)-mid).x.(psample(i+1)-mid) ! not unit yet
   unit_w = unit_w + unit(unit_v)
 end do
 unit_v = (psample(n)-mid).x.(psample(1)-mid) ! not unit yet
 unit_w = unit_w + unit(unit_v)
 unit_w = unit(unit_w/n)
 i=4
 unit_v=((psample(i)-mid)-((psample(i)-mid)*unit_w)*unit_w)/sqrt(norm2(psample(i)-mid)-((psample(i)-mid)*unit_w)**2)
 unit_u=unit(unit_v.x.unit_w)
 
 unit_u=ii
 unit_v=jj
 unit_w=kk
 
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!
!mid=sum(psample)/24
!print *, mid
!
!unit_w=unit(sum(unit(psample-mid))/24)
!
!allocate(loc,source=minloc(abs((psample-mid)*unit_w)))
!
!i=loc(1)
!unit_v=((psample(i)-mid)-((psample(i)-mid)*unit_w)*unit_w)/sqrt(norm2(psample(i)-mid)-((psample(i)-mid)*unit_w)**2)
!unit_u=unit(unit_v.x.unit_w)
!
!
!
!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
print *, " New Coord Stuff"
origin=O
print *, unit_W
print *, unit_w*unit_v, norm(unit_w)
!print *, ii.x.jj, ortho2ortho(unit_u.x.unit_v,unit_u,unit_v,unit_w)
print *, unit_w*unit_u, norm(unit_u)
!print *, jj.x.kk, ortho2ortho(unit_v.x.unit_w,unit_u,unit_v,unit_w)
print *, unit_u*unit_v, norm(unit_v)
!print *, kk.x.ii, ortho2ortho(unit_w.x.unit_u,unit_u,unit_v,unit_w)

!psample=ortho2ortho(psample,origin,unit_u,unit_v,unit_w)

!unit_w=kk
!unit_v=jj
!unit_u=ii

! basis functions to be used for the fit
!call myfit%set(poly3D)
! remove z-terms
!call myfit%set(linear_xy)
!call myfit%set(quadratic_xy)
!call myfit%set(cubic_xy)
!call myfit%set(bicubic_xy)
!call myfit%set(fourth_xy)
!call myfit%set(quad_onlysq_xy)
!mid = sum(psample(1:3))/3
! 
 mapbase%dim = 2
 mapbase%fun => cheby1
 mapbase%dfun => dcheby1
 mapbase%ddfun => ddcheby1
 !mapbase%fun => cpoly
 !mapbase%dfun => dcpoly
 !mapbase%ddfun => ddcpoly
 
 do i = 2, 3
     
     mapbase%order = i
     print *,mapbase%size()
     !if ( mapbase%size() == size(psample) ) exit
     
     if ( mapbase%size()+1 >=  size(psample) ) then
       mapbase%order = mapbase%order - 1
       exit
     end if
     
 end do 
 
 print *, '---------'
 print *, mapbase%order
 print *, '---------'
 call myfit%set(mapbase)
 
!call myfit%solve(psample,psample%z)

origin=O
!origin%z=myfit%seval(O)
!unit_w=unit(myfit%gradient(O))


!mid%z=0d0
!call myfit%set(mid)

!gaussw%l=minval(norm(psample-O))

!call myfit%set(idist3)
!idistn%n=-4
!call myfit%set(idistn)
!gaussw%l=maxval(norm(psample-O))
!print *, gaussw%l
!call myfit%set(gaussw)

! evaluate lsq fit
call set_almost_zero(1d-10)
call set_lsq_svd_tol(1d-6)
!myfit%solve_method=solve_by_svd
!myfit%remove_small_Aij=.true.
call myfit%solve(psample,psample%z,AA=AA,sing_flag=is_sing)
!call myfit%fsolve(psample,psample%z,sing_flag=is_sing)
print *, is_sing
!print *, "A(i,i)="
!do i =1,size(AA,1)
!print *, AA
!end do
!print *,"-----|"

!call myfit%solve(psample,)x
!call myfit%solve(psample,psample%z-mid%z)
!allocate(f(size(psample)),source=0d0)
!psample%z=0d0
!call myfit%solve(psample,f)

print *, "Err Sum", myfit%rsumE2(psample,psample%z)
!print *, myfit%rsumE2(psample,psample%z-mid%z)

!mid=psample(24)

 csum=0d0

 
!myfit%coeffs=[ &
! -1.754314189715212E-003 ,-4.459815045400890E-009 ,-1.230878848090023E-003 , &
!  -2.216094461323634E-011,  1.182817630749300E-003, -1.189167928598368E-006, &
!  -3.503147078844205E-008, -1.690585338289291E-009, -4.503925814379294E-008, &
!  -7.061564164442064E-004,  2.393540022573457E-011, -9.996070955107964E-007, &
!  -8.465370723559709E-010,  4.278958112162439E-014, -2.502707479224288E-007 ]
 
!call myfit%set(quadratic_xy)
!do i=1,size(psample)
!gradfit = myfit%gradient(psample(i))
!Hess = myfit%hessian(psample(i))
!gradfit = myfit%gradient(mid)
!Hess = myfit%hessian(mid)
gradfit = myfit%gradient(point(-(bx+ax)/(bx-ax),-(by+ay)/(by-ay),0d0))
gradfit%vx = gradfit%vx * sfx
gradfit%vy = gradfit%vy * sfy
Hess = myfit%hessian(point(-(bx+ax)/(bx-ax),-(by+ay)/(by-ay),0d0))
Hess(1) = Hess(1)*sfx**2
Hess(2) = Hess(2)*sfx*sfy
Hess(4) = Hess(4)*sfy**2

print *, "Grad="
print *, gradfit
print *, " Hess="
print *, Hess
print *, "---"

 area_sumparts = sqrt(gradfit%vx**2+gradfit%vy**2+1d0)

 curvature = (-Hess(1)*(gradfit%vy**2 + 1d0)-Hess(4)*(gradfit%vx**2 + 1d0)+2d0*gradfit%vx*gradfit%vy*Hess(2)) &
                    / (area_sumparts**3d0)

!print *, norm(mid-psample(i)),curvature
!print *, "curv=",curvature
print *, "curv=",curvature!*2d0/(bz-az)
!print *, "curv_c=",(4d0*myfit%coeffs(5)*myfit%coeffs(6)-myfit%coeffs(4))/(myfit%coeffs(2)**2+myfit%coeffs(3)**2+1d0)
! csum=csum+curvature
!end do

! print*, csum/size(psample)

print *, "R=",sum(norm(psample-O))/size(psample),"K=",2d0/(sum(norm(psample-O))/size(psample))
!print *, norm(psample-O)
mid=point(minval(psample%x),minval(psample%y),0d0)

allocate(gridp,source=make_grid(mid,ii,jj,maxval(abs(mid%x-psample%x)),maxval(abs(mid%y-psample%y)),200,200))

open(100,file="fort.m")
write(100,*), 'sps=['
write(100,*), psample
write(100,*), ']'
gridp%z=myfit%seval(gridp)
write(100,*), 'fps=['
write(100,*), gridp
write(100,*), ']'
close(100) 

print*, "Coef="
print*, myfit%coeffs
print*, "norm="
print*, unit((-gradfit%vx)*unit_u+(-gradfit%vy)*unit_v+unit_w)

! mapbase%dim=3
! mapbase%order=3
! 
! allocate(is,source = (/1:mapbase%size()/))
! allocate(i0(size(is)),j0(size(is)),k0(size(is)))
! !call mapbase%map_Idim_2d(is,i0,j0)
! call cpu_time(t1)
! call mapbase%map_Idim_3d(is,i0,j0,k0)
! call cpu_time(t2)
! print *, t2-t1
! print *, '-----------'
! do i=1,size(is)
! print *, i0(i), j0(i), k0(i)
! end do



end program test_fit4curv
